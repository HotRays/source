From 5afd2f238041795e6924ac18a02098e1c86ea5b6 Mon Sep 17 00:00:00 2001
From: fengmushu <fengmushu@gmail.com>
Date: Wed, 9 May 2018 23:20:52 +0800
Subject: [PATCH] fixup AP6536s reset pin

---
 .../boot/dts/allwinner/sun50i-h6-tempe-a55.dts     | 39 ++++++++++++++++------
 arch/arm64/boot/dts/allwinner/sun50i-h6.dtsi       | 38 +++++++++++++++++++++
 2 files changed, 66 insertions(+), 11 deletions(-)

diff --git a/arch/arm64/boot/dts/allwinner/sun50i-h6-tempe-a55.dts b/arch/arm64/boot/dts/allwinner/sun50i-h6-tempe-a55.dts
index 77656c7..3568e18 100644
--- a/arch/arm64/boot/dts/allwinner/sun50i-h6-tempe-a55.dts
+++ b/arch/arm64/boot/dts/allwinner/sun50i-h6-tempe-a55.dts
@@ -52,17 +52,18 @@
 
 	wifi_pwrseq: wifi_pwrseq {
 		compatible = "mmc-pwrseq-simple";
-		reset-gpios = <&r_pio 1 3 GPIO_ACTIVE_HIGH>; /* PM3 */
+		reset-gpios = <&r_pio 1 3 GPIO_ACTIVE_LOW>; /* PM3 */
 		post-power-on-delay-ms = <50>;
 	};
 
 	reg_usb_vbus: vbus {
 		compatible = "regulator-fixed";
 		regulator-name = "usb-vbus";
-		// regulator-min-microvolt = <5000000>;
-		// regulator-max-microvolt = <5000000>;
+		regulator-min-microvolt = <5000000>;
+		regulator-max-microvolt = <5000000>;
 		/* startup-delay-us = <100>; */
-		gpio = <&pio 3 7 GPIO_ACTIVE_HIGH>; /* PD7 */
+		/* not need for a55, ctl by user gpio. gpio = <&pio 3 7 GPIO_ACTIVE_HIGH>; /* PD7 */
+		enable-active-high;
 		regulator-boot-on;
 	};
 };
@@ -71,6 +72,15 @@
 	cpu-supply = <&reg_dcdca>;
 };
 
+&pio {
+	ec20_gpio: overwrite { /* overwrite */
+		pins = "PD0", "PD1", "PD2", "PD3", "PD4",
+			"PD5", "PD7", "PD8", "PD9", "PD10", "PD11";
+		function = "gpio_in";
+		bias-pull-down;
+	};
+};
+
 &emac {
 	pinctrl-names = "default";
 	pinctrl-0 = <&inner_rmii_pins>;
@@ -171,6 +181,7 @@
 			};
 
 			reg_bldo3: bldo3 {
+				regulator-always-on;
 				regulator-min-microvolt = <1800000>;
 				regulator-max-microvolt = <1800000>;
 				regulator-name = "vcc-wifi-io";
@@ -234,12 +245,6 @@
 			};
 		};
 	};
-
-	pcf8563: rtc@51 {
-		compatible = "nxp,pcf8563";
-		reg = <0x51>;
-		#clock-cells = <0>;
-	};
 };
 
 &twi0 {
@@ -274,6 +279,17 @@
 	};
 };
 
+&twi3 {
+	pinctrl-names = "default";
+	pinctrl-0 = <&twi3_pins>;
+	status = "okay";
+
+	ac200: i2c@10 {
+		compatible = "ac200,cdc";
+		reg = <0x10>;
+	};
+};
+
 &uart0 {
 	pinctrl-names = "default";
 	pinctrl-0 = <&uart0_ph_pins>;
@@ -310,7 +326,8 @@
 };
 
 &usb2phy {
-	phy-supply = <&reg_usb_vbus>;
+	usb0_vbus-supply = <&reg_usb_vbus>;
+	usb3_vbus-supply = <&reg_usb_vbus>;
 	status = "okay";
 };
 
diff --git a/arch/arm64/boot/dts/allwinner/sun50i-h6.dtsi b/arch/arm64/boot/dts/allwinner/sun50i-h6.dtsi
index 8887d4a..f7d2f3d 100644
--- a/arch/arm64/boot/dts/allwinner/sun50i-h6.dtsi
+++ b/arch/arm64/boot/dts/allwinner/sun50i-h6.dtsi
@@ -165,6 +165,14 @@
 				drive-strength = <40>;
 			};
 
+			ac200_ccir_pins: ccir_pins {
+				pins = "PB0", "PB1", "PB2", "PB3", "PB4",
+					   "PB5", "PB6", "PB7", "PB8", "PB9",
+					   "PB10", "PB11";
+				function = "ccir";
+				drive-strength = <40>;
+			};
+
 			ext_rgmii_pins: rgmii_pins {
 				pins = "PD0", "PD1", "PD2", "PD3", "PD4",
 				       "PD5", "PD7", "PD8", "PD9", "PD10",
@@ -223,6 +231,25 @@
 				drive-strength = <20>;
 				bias-pull-up;
 			};
+
+			twi3_pins: twi3-pb {
+				pins = "PB17", "PB18";
+				function = "i2c3";
+				drive-strength = <20>;
+				bias-pull-up;
+			};
+		};
+
+		rtc: rtc@07000000 {
+			compatible = "allwinner,sun50i-h6-rtc";
+			reg = <0x07000000 0x200>;
+			interrupts = <GIC_SPI 101 IRQ_TYPE_LEVEL_HIGH>;
+		};
+
+		wdt: watchdog@030090a0 {
+			compatible = "allwinner,sun50i-h6-wdt";
+			reg = <0x030090a0 0x20>;
+			interrupts = <GIC_SPI 50 IRQ_TYPE_LEVEL_HIGH>;
 		};
 
 		mmc0: mmc@4020000 {
@@ -528,5 +555,16 @@
 			#address-cells = <1>;
 			#size-cells = <0>;
 		};
+
+		twi3: i2c@05002c00 {
+			compatible = "allwinner,sun6i-a31-i2c";
+			reg = <0x05002c00 0x400>;
+			interrupts = <GIC_SPI 7 IRQ_TYPE_LEVEL_HIGH>;
+			clocks = <&ccu CLK_BUS_I2C3>;
+			resets = <&ccu RST_BUS_I2C3>;
+			status = "disabled";
+			#address-cells = <1>;
+			#size-cells = <0>;
+		};
 	};
 };
-- 
2.14.2

